"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1252],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(n),d=i,h=c["".concat(l,".").concat(d)]||c[d]||m[d]||o;return n?a.createElement(h,r(r({ref:t},p),{},{components:n})):a.createElement(h,r({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var u=2;u<o;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},2465:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=n(7462),i=(n(7294),n(3905));const o={slug:"Arch-Linux-with-Yubico-U2F",title:"Arch Linux with Yubico U2F",authors:"IgorKha",tags:["security","key","yubico","U2F","FIDO2","arch","linux","pam","sddm","ssh"]},r=void 0,s={permalink:"/blog/Arch-Linux-with-Yubico-U2F",editUrl:"https://github.com/IgorKha/igorkha.github.io/tree/main/blog/2022-11-26-Arch-Linux-with-Yubico-U2F/index.md",source:"@site/blog/2022-11-26-Arch-Linux-with-Yubico-U2F/index.md",title:"Arch Linux with Yubico U2F",description:"Linux-u2f.png",date:"2022-11-26T00:00:00.000Z",formattedDate:"November 26, 2022",tags:[{label:"security",permalink:"/blog/tags/security"},{label:"key",permalink:"/blog/tags/key"},{label:"yubico",permalink:"/blog/tags/yubico"},{label:"U2F",permalink:"/blog/tags/u-2-f"},{label:"FIDO2",permalink:"/blog/tags/fido-2"},{label:"arch",permalink:"/blog/tags/arch"},{label:"linux",permalink:"/blog/tags/linux"},{label:"pam",permalink:"/blog/tags/pam"},{label:"sddm",permalink:"/blog/tags/sddm"},{label:"ssh",permalink:"/blog/tags/ssh"}],readingTime:5.755,hasTruncateMarker:!0,authors:[{name:"IgorKha",url:"https://github.com/IgorKha",imageURL:"https://github.com/IgorKha.png",key:"IgorKha"}],frontMatter:{slug:"Arch-Linux-with-Yubico-U2F",title:"Arch Linux with Yubico U2F",authors:"IgorKha",tags:["security","key","yubico","U2F","FIDO2","arch","linux","pam","sddm","ssh"]},nextItem:{title:"Bandwidth ZeroTier on NXP LS1046",permalink:"/blog/Bandwidth-ZeroTier-on-NXP-LS1046"}},l={authorsImageUrls:[void 0]},u=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installation the pam-u2f",id:"installation-the-pam-u2f",level:2},{value:"Arch Linux",id:"arch-linux",level:3},{value:"Debian/Ubuntu",id:"debianubuntu",level:3},{value:"Source code",id:"source-code",level:3},{value:"Configure Security keys",id:"configure-security-keys",level:2},{value:"Individual Authorization Mapping by User",id:"individual-authorization-mapping-by-user",level:3},{value:"Central Authorization Mapping",id:"central-authorization-mapping",level:3},{value:"Activate the pam_u2f.so module in PAM",id:"activate-the-pam_u2fso-module-in-pam",level:2},{value:"Dealing with SDDM",id:"dealing-with-sddm",level:3},{value:"Passwordless sudo with U2F",id:"passwordless-sudo-with-u2f",level:3},{value:"SSH Credentials",id:"ssh-credentials",level:2},{value:"Additional information",id:"additional-information",level:2}],p={toc:u};function m(e){let{components:t,...o}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Linux-u2f.png",src:n(7572).Z,width:"620",height:"403"})),(0,i.kt)("p",null,"This method will work with ANY security keys that support the U2F standard"),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A Security key supporting the U2F Standard"),(0,i.kt)("li",{parentName:"ul"},"Linux"),(0,i.kt)("li",{parentName:"ul"},"root access to the System you are gonna configure 2FA for")),(0,i.kt)("h2",{id:"installation-the-pam-u2f"},"Installation the pam-u2f"),(0,i.kt)("h3",{id:"arch-linux"},"Arch Linux"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"sudo pacman -Sy --needed pam-u2f")),(0,i.kt)("h3",{id:"debianubuntu"},"Debian/Ubuntu"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"sudo apt update && sudo apt install libpam-u2f")),(0,i.kt)("h3",{id:"source-code"},"Source code"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yubico/pam-u2f"},"Github")),(0,i.kt)("h2",{id:"configure-security-keys"},"Configure Security keys"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"pam-u2f")," package provides a handy tool to configure Security Keys for our users called ",(0,i.kt)("inlineCode",{parentName:"p"},"pamu2fcfg")),(0,i.kt)("h3",{id:"individual-authorization-mapping-by-user"},"Individual Authorization Mapping by User"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create folder:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"mkdir -p ~/.config/Yubico"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Make user keys:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"pamu2fcfg > ~/.config/Yubico/u2f_keys")),(0,i.kt)("p",{parentName:"li"},"2.1 Add Additional keys using"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"pamu2fcfg >> ~/.config/Yubico/u2f_keys")))),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"pamu2fcfg example output:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text",metastring:'title="~/.config/Yubico/u2f_keys"',title:'"~/.config/Yubico/u2f_keys"'},"username:1pQTIDIGWLfyRhYjiFpJeSlSxN4fqdY0ucl59VxQdS0qV9QxDgb5HGL1Hd18o1gQ1wr9B3BP60tk4735JrIE7A==,KPMgCkrhND9yMKaImqwgywBVJlIHc8rDUVbMirXCG70X+bzld/a6HWOjaSlzUXinVp3yfofx96wgmSWkGX6poQ==,es256,+presence\n")),(0,i.kt)("h3",{id:"central-authorization-mapping"},"Central Authorization Mapping"),(0,i.kt)("p",null,"Create a file e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/u2f_mappings"),". The file must contain a user name, and the information obtained during the registration procedure."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pamu2fcfg -u username1 >> /etc/u2f_mappings")),(0,i.kt)("h2",{id:"activate-the-pam_u2fso-module-in-pam"},"Activate the pam_u2f.so module in PAM"),(0,i.kt)("p",null,"Configure pam-u2f as a ",(0,i.kt)("inlineCode",{parentName:"p"},"required")," module after your primary authentication module(s) for use as a second factor. Make sure that the primary authentication method is not ",(0,i.kt)("inlineCode",{parentName:"p"},"sufficient")," or uses other control values that may preempt execution of pam-u2f."),(0,i.kt)("h3",{id:"dealing-with-sddm"},"Dealing with SDDM"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For correctly work SDDM with U2F, need to change ",(0,i.kt)("inlineCode",{parentName:"p"},"system-login")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"system-local-login")," into ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/pam.d/sddm")," Failing to do this will result in the KDE lock screen, and terminal access requiring U2F, but the initial login via SDDM bypassing U2F, which defeats the purpose of having two factor authentication.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the following line to config file (change ",(0,i.kt)("inlineCode",{parentName:"p"},"username"),")"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"auth            required        pam_u2f.so authfile=/home/<username>/.config/Yubico/u2f_keys")))),(0,i.kt)("p",null,"sddm config ",(0,i.kt)("strong",{parentName:"p"},"before")," adding U2F:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text",metastring:'title="/etc/pam.d/sddm"',title:'"/etc/pam.d/sddm"'},"#%PAM-1.0\n\nauth           include         system-login\n-auth           optional        pam_gnome_keyring.so\n-auth   optional  pam_kwallet5.so\n\naccount         include         system-login\n\npassword        include         system-login\n-password       optional        pam_gnome_keyring.so use_authtok\n\nsession         optional        pam_keyinit.so force revoke\nsession         include         system-login\n-session                optional        pam_gnome_keyring.so auto_start\n-session  optional  pam_kwallet5.so auto_start\n")),(0,i.kt)("p",null,"sddm config ",(0,i.kt)("strong",{parentName:"p"},"after")," adding U2F:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text",metastring:'title="/etc/pam.d/sddm"',title:'"/etc/pam.d/sddm"'},"#%PAM-1.0\n\n// highlight-next-line\nauth            include         system-local-login\n-auth           optional        pam_gnome_keyring.so\n-auth   optional  pam_kwallet5.so\n// highlight-next-line\nauth            required        pam_u2f.so authfile=/home/<username>/.config/Yubico/u2f_keys\n\naccount         include         system-login\n\npassword        include         system-login\n-password       optional        pam_gnome_keyring.so use_authtok\n\nsession         optional        pam_keyinit.so force revoke\nsession         include         system-login\n-session                optional        pam_gnome_keyring.so auto_start\n-session  optional  pam_kwallet5.so auto_start\n")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Add the same version to the top of ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/pam.d/kde")," to protect the KDE Plasma lock screen."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"auth            required        pam_u2f.so authfile=/home/<username>/.config/Yubico/u2f_keys"))),(0,i.kt)("admonition",{title:"PAM Configuration (Reference)",type:"info"},(0,i.kt)("details",null,(0,i.kt)("summary",null,"PAM Configuration File Syntax"),(0,i.kt)("p",{parentName:"admonition"},"The entries in the configuration file are in the format:"),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"service-name module-type control-flag module-path module-options"))),(0,i.kt)("hr",{parentName:"admonition"}),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"service-name")," - Name of the service, for example, ",(0,i.kt)("inlineCode",{parentName:"p"},"ftp"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"login"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"passwd"),". An application can use different service names for the services that the application provides. For example, the Solaris secure shell daemon uses these service names: ",(0,i.kt)("inlineCode",{parentName:"p"},"sshd-none"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"sshd-password"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"sshd-kbdint"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"sshd-pubkey"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"sshd-hostbased"),". The service-name other is a predefined name that is used as a wildcard service-name. If a particular service-name is not found in the configuration file, the configuration for other is used."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"module-type")," - The type of service, that is, auth, account, session, or password."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"control-flag")," - Indicates the role of the module in determining the integrated success or failure value for the service. Valid control flags are binding, include, optional, required, requisite, and sufficient. See below how PAM Stacking Works for information on the use of these flags."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"module-path")," - The path to the library object that implements the service. If the pathname is not absolute, the pathname is assumed to be relative to ",(0,i.kt)("inlineCode",{parentName:"p"},"/usr/lib/security/$ISA/"),". Use the architecture-dependent macro $ISA to cause ",(0,i.kt)("inlineCode",{parentName:"p"},"libpam")," to look in the directory for the particular architecture of the application."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"module-options")," - Options that are passed to the service modules. A module's man page describes the options that are accepted by that module. Typical module options include ",(0,i.kt)("inlineCode",{parentName:"p"},"nowarn")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"debug"),".")),(0,i.kt)("details",null,(0,i.kt)("summary",null,"How PAM Stacking Works"),(0,i.kt)("p",{parentName:"admonition"},"The control flag indicates the role that a PAM module plays in determining access to the service. The control flags and their effects are:"),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Binding")," \u2013 Success in meeting a binding module's requirements returns success immediately to the application if no previous required modules have failed. If these conditions are met, then no further execution of modules occurs. Failure causes a required failure to be recorded and the processing of modules to be continued."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Include")," \u2013 Adds lines from a separate PAM configuration file to be used at this point in the PAM stack. This flag does not control success or failure behaviors. When a new file is read, the PAM include stack is incremented. When the stack check in the new file finishes, the include stack value is decremented. When the end of a file is reached and the PAM include stack is 0, then the stack processing ends. The maximum number for the PAM include stack is 32."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Optional")," \u2013 Success in meeting an optional module's requirements is not necessary for using the service. Failure causes an optional failure to be recorded."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Required")," \u2013 Success in meeting a required module's requirements is necessary for using the service. Failure results in an error return after the remaining modules for this service have been executed. Final success for the service is returned only if no binding or required modules have reported failures."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Requisite")," \u2013 Success in meeting a requisite module's requirements is necessary for using the service. Failure results in an immediate error return with no further execution of modules. All requisite modules for a service must return success for the function to be able to return success to the application."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},"Sufficient")," \u2013 If no previous required failures have occurred, success in a sufficient module returns success to the application immediately with no further execution of modules. Failure causes an optional failure to be recorded."),(0,i.kt)("p",{parentName:"admonition"},"The following two diagrams shows how access is determined in the integration process. The first diagram indicates how success or failure is recorded for each type of control flag. The second diagram shows how the integrated value is determined."),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"Effect of Control Flags"))),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("img",{alt:"img",src:n(2422).Z,width:"555",height:"630"})),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"How Integrated Value Is Determined"))),(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("img",{alt:"img",src:n(5056).Z,width:"518",height:"484"})))),(0,i.kt)("h3",{id:"passwordless-sudo-with-u2f"},"Passwordless sudo with U2F"),(0,i.kt)("p",null,"You can use U2F key for Passwordless sudo i.e only the U2f key would be needed to run sudo commands"),(0,i.kt)("p",null,"We can achieve this by editing the ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/pam.d/sudo")," file"),(0,i.kt)("p",null,"Add the following line to the TOP of the sudo file"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"auth            sufficient        pam_u2f.so authfile=/home/<username>/.config/Yubico/u2f_keys cue [cue_prompt=<Prompt we want to show to our users>]")),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text",metastring:'title="/etc/pam.d/sudo"',title:'"/etc/pam.d/sudo"'},"#%PAM-1.0\n// highlight-next-line\nauth            sufficient        pam_u2f.so authfile=/home/<username>/.config/Yubico/u2f_keys cue [cue_prompt=Please Confirm Your Identity.]\nauth            include         system-auth\naccount         include         system-auth\nsession         include         system-auth\n\n")),(0,i.kt)("h2",{id:"ssh-credentials"},"SSH Credentials"),(0,i.kt)("p",null,"To generate SSH credentials OpenSSH version 8.2 or later is required. It is then possible to generate a credential file with:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ssh-keygen -t ecdsa-sk -f ./.ssh/filename")),(0,i.kt)("p",null,"or"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ssh-keygen -t ed25519-sk -f ./.ssh/filename")),(0,i.kt)("h2",{id:"additional-information"},"Additional information"),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://developers.yubico.com/yubikey-manager-qt/Releases/yubikey-manager-qt-latest-linux.AppImage"},"YubiKey Manager AppImage")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Yubico/pam-u2f"},"pam-u2f")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://wiki.archlinux.org/title/PAM#PAM_base-stack"},"PAM base-stack in Arch Linux")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://wiki.archlinux.org/title/YubiKey#Linux_user_authentication_with_PAM"},"Linux user authentication with PAM")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Yubico/pam-u2f#module-arguments"},"More information for module arguments")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/agherzan/yubikey-full-disk-encryption"},"YubiKey Full Disk Encryption")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://support.yubico.com/hc/en-us/articles/360016649039-Installing-Yubico-Software-on-Linux"},"Installing Yubico Software on Linux")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://support.yubico.com/hc/en-us/articles/360013708900-Using-Your-U2F-YubiKey-with-Linux"},"Using Your U2F YubiKey with Linux")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://support.yubico.com/"},"Yubico Support")))))}m.isMDXComponent=!0},7572:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Linux-u2f-d191082d2c598f7ab0e515a72058ea97.png"},2422:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/pam.run_stack1-1571d98e7a04d8bb2bac3df5a51381bf.png"},5056:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/pam.run_stack2-ac28c1fe548d666dbe0c30a1ed33a47f.png"}}]);